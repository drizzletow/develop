# 一 从单体应用到微服务

## 1. 单体架构应用的优劣

到目前为止，我们所实现的web应用都有一个共同的特点，所有的代码最终打包成一个或多个文件，整个系统的所有功能单元整体部署到同一个进程，这种软件架构的风格，即所谓的"单体架构"

```bash 

在单体应用的早期，应用程序相对较小，单体架构的好处：
- 应用的开发很简单
- 易于对应用程序进行大规模的更改
- 测试相对直观简单
- 部署简单明了
- 横向扩容不费吹灰之力

```

<br>

一个单体应用在运行时，会部署在一台服务器上，但是随着用户体量的增长，单体应用已经无法承载日益增长的请求量，怎么办呢？我们可以对单体应用实现扩容，即使用单体应用集群

![image-20220515103848144](vx_images/image-20220515103848144.png)



随着时间的推移，单体应用中包含的功能越来越多，应用的"体积"越来越大，单体应用的弊端就会逐渐体现出来。

- 代**码过度复杂且严重耦合，导致难以维护** 

  由于系统本身过于庞大和复杂，以至于任何一个开发者都很难理解它的全部，因此，修复软件中的问题和正确实现新功能就变得困难且耗时。更糟糕的是，这种极度的复杂性，可能会形成一个恶性循环: 由于代码难以理解，因此开发者在更改时更容易出错，每一次更改都会让代码库变得更复杂，更难懂

- **从代码提交到实际部署的周期很长** 

  从代码完成到运行在生产环境，是一个漫长且费力的过程。

  众多开发人员都向同一个代码库提交代码，常常使得代码库的构建结构处于无法交付的状态。当采用了分支来解决这个问题，又必须忍受漫长且痛苦的合并过程。因为代码库中的代码十分复杂，以至于任何一个更改可能引起的影响是未知的，为了避免牵一发而动全身的后果，即使是一个微小的更改，也必须执行全部的测试

- **扩展性受限** 

  如果单体应用中的某一个功能点存在性能问题，那么就需要多部署几个单体应用的实例，再加上负载均衡的设备(比如nginx)，才能保证整个应用的性能能够支撑用户的使用。在某些情况下，应用的不同模块对资源的需求是相互冲突的，比如某些模块需要高效的IO，某些模块需要高性能的CPU, 而这些模块都在一个单体应用之内，因此其所部署的 服务器必须满足所有的需求

- **开发慢，启动慢，严重影响开发效率** 

- **交付可靠的单体应用困难** 

  单体应用体积庞大，难以进行全面和彻底的测试，而缺乏可靠的测试意味着代码中的错误会进入生产环境。缺乏故障隔离，因为所有的模块都在同一个进程中运行，每隔一段时间，在一个模块中的代码错误，将会导致整个应用程序的崩溃

<br>



## 2. 微服务及微服务架构

微服务的本质就是一个麻雀虽小但五脏俱全的应用程序，它按照单一职责原则实现了特定的一组功能。
因为每个微服务的本质都可以是一个应用程序，这就要求，微服务可以独立部署，独立运行，独立对外提供服务(运行在一个独立的进程中)，每个微服务，根据单一职责原则，实现一组相关功能

<br>

什么是微服务架构呢？简单理解，就是把应用程序功分解为一组服务的架构风格。实际上，微服务架构是模块化开发的一种形式。
模块化是开发大型，复杂应用程序的基础。当一个单体应用程序的规模太大的时候，是很难作为一个整体开发，也很难让一个人完全理解的。为了让不同的人开发和理解(不同的部分)，大型应用需要拆分模块。

- 在单体应用中，模块通常由一组编程语言所提供的的结构(例如Java中的包，或者jar文件)来定义，但是通过这种方式得到的模块，不同模块的代码还是可以相互引用，导致模块中对象依赖关系的混乱。

- 而微服务架构，使用微服务作为模块化的单元，要访问服务，只能通过服务对外提供的API，于是服务的API为它自身构筑了一个不可逾越的边界，你无法越过API去访问服务内部的类。

<br>

### 微服务的优势和弊端

使用微服务架构，可以解决庞大的单体应用的痛点，带来很多好处：

- 每个服务都相对较小，容易维护

- 使得大型的应用程序实现快速的持续交付和持续部署

  1. 每一个服务相对较小，编写全面的测试代码和执行自动化测试都变得相对容易
  2. 每个服务都独立于其他服务部署，如果负责服务的开发人员，需要部署对该服务的更改，不需要与其他开
  发人员协商，因此将更改频繁部署到生产中要容易的多
  3. 每个小团队，就可以全权负责一个或多个服务的开发，每个团队独立于所有其他团队，开发，部署和扩
  展，实现了团队自治，减少了团队之间的沟通成本

- 应用扩展灵活

  1. 应用被拆分为不同的微服务，而微服务可以独立部署，因此，扩容就不在针对整个应用了，哪里出现性能
     瓶颈，对哪个服务扩容即可

  2. 即使不同的的服务需要资源存在冲突，也没有关系，把它们分别部署到具有拥有各自所需要资源的机器上
  即可

- 更好的容错

  相比于单体架构中，一个故障拖垮整个系统的情况，一个服务的故障，并不会影响想到其他服务的正常运行。

<br>

当然，使用微服务也会带来一些弊端

- 分布式系统可能复杂难以管理
- 分布式部署追踪问题难
- 分布式事务比较难处理
- 服务数量增加，管理复杂性增加



<br>



## 3. 微服务的拆分与实现

服务的拆分：

<img src="vx_images/image-20220515105604449.png" alt="image-20220515105604449" style="zoom:67%;" />



想要将微服务架构在项目中落地，还需要解决一些其他问题，服务之间的调用，服务的治理，比如服务的注册与自动
发现，服务调用的负载均衡等等

当然这些问题，都已经有相应的服务框架帮助我们实现了，所以我们在实现微服务架构的项目，都需要基于某个微服务的框架，目前比较流行的有SpringCloud和Dubbo，目前主流几乎都是基于SpringCloud。

SpringCloud 是基于SpringBoot提供的一套微服务架构实现解决方案，包括服务的注册与自动发现，面向接口的服务调用，服务调用的负载均衡，服务网关，服务熔断等等组件，它利用SpringBoot开发的便利性，巧妙的简化了分布式系统的基础设施搭建，使开发者可以基于SpringBoot的开发风格做到快速启动和部署。



<br>



# 二 微服务架构及解决方案

## 1. 微服务通用组件介绍

### 服务注册中心

用来管理微服务架构中每一个服务健康状态以及服务元数据存储。技术栈介绍：

- **Eureka**：所属 Netflix ，包括EurekaServer和EurekaClient. （建议使用以下几种代替）

  

- **Zookeeper**：所属Apache，JAVA语言实现 

  经典的服务注册中心，ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务。

  它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。

  

- **Consul**：所属SpringCloud，GO语言实现

  Consul是一个服务网格（微服务间的 TCP/IP，负责服务之间的网络调用、限流、熔断和监控）解决方案

  它是一个一个分布式的，高度可用的系统，而且开发使用都很简便。

  它提供了一个功能齐全的控制平面，主要特点是：服务发现、健康检查、键值存储、安全服务通信、多数据中心。

  

- **Nacos：** 所属Alibaba，JAVA语言实现

  **Nacos 支持基于 DNS 和基于 RPC 的服务发现（可以作为springcloud的注册中心）、动态配置服务（可以做配置中心）、动态 DNS 服务** 。

<br>



### 服务配置中心

用来将微服务的配置文件进行远端仓库统一管理。技术栈：

- **Spring Cloud Config**：提供统一配置的功能，

  ConfigServer 用来获取远端仓库配置,并存入本地仓库、ConfigClient根据ConfigServer 读取自身配置.

- **Spring Cloud Bus**（消息总线）：提供了配置实时更新的功能

  通过MQ将微服务的所有节点连接到一起通过消息总线实现自动配置刷新。

- **Nacos**：所属Alibaba，兼顾配置注册中心和配置中心。

  Nacos 支持基于 DNS 和基于 RPC 的服务发现、动态配置服务、动态 DNS 服务。

<br>



### 服务间通信组件

两种主要的实现方式：

- **Dubbo的RPC方式**（底层基于Netty实现，而Netty底层基于Java NIO，基于TCP建立的长连接）

- **SpringCloud的HTTP Restful方式**，短连接的方式。

  HTTP Restful方式性能不如RPC，但可跨异构系统，不要求各系统使用同一种语言。

  HTTP Restful方式有两种实现方案：

  - `RestTemplate`（路径写死、没有负载均衡）+ Ribbon（所属Netflix ，实现负载均衡）

    默认情况下，RestTemplate默认依赖jdk的HTTP连接工具

  - `OpenFeign`（所属SpringCloud，封装了Netflix 的Feign，自带负载均衡）

```bash

一般情况下我们所说的负载均衡通常都是指服务端负载均衡，负载均衡器会维护一个可用的后端服务器清单，然后通过心跳机制来删除故障的服务端节点以保证清单中都是可以正常访问的服务端节点，此时当客户端的请求到达负载均衡服务器时，负载均衡器按照某种配置好的规则从可用服务端清单中选出一台服务器去处理客户端的请求。

客户端负载均衡和服务端负载均衡最大的区别在于服务清单所存储的位置。在客户端负载均衡中，所有的客户端节点都有一份自己要访问的服务端清单，这些清单统统都是从Eureka服务注册中心获取的。在Spring Cloud中我们如果想要使用客户端负载均衡，方法很简单，开启@LoadBalanced注解即可，这样客户端在发起请求的时候会先自行选择一个服务端，向该服务端发起请求，从而实现负载均衡。

```

- Ribbon：Spring Cloud Ribbon是一个基于HTTP和TCP的客户端负载均衡工具，它基于Netflix Ribbon实现。

  通过Spring Cloud的封装，可以让我们轻松地将面向服务的REST模版请求自动转换成客户端负载均衡的服务调用。

- LoadBalancer：LoadBalancer 可以将来自客户端的请求分发到不同的服务器

  通过将一系列的请求转发到不同的服务器可以提高服务器的性能，并可以自动地寻找最优的服务器转发请求，这样不仅提高了系统性能，同时达到了负载均衡的目的

<br>



### 服务熔断组件

采用服务熔断或服务降级的方式解决服务雪崩问题，技术栈：

- Hystrix (所属Netflix)

- Resilience4j： Resilience4j是受Netflix的Hysrix项目启发，专门为Java 8 和函数式编程设计的轻量级容错框架

- Sentinel（所属Alibaba）

  Sentinel支持的熔断降级维度更多，可对多种指标进行流控、熔断，且提供了实时监控和控制面板，功能更为强大

<br>



### 服务网关组件

用来统一服务总入口，实现路由转发和过滤，技术栈：

- Zuul：Zuul1.x、Zuul2.x (所属Netflix)
- Gateway（所属SpringCloud）

Spring Cloud Gateway是Spring官方基于Spring 5.0，Spring Boot 2.0和Project Reactor等技术开发的网关，

Spring Cloud Gateway旨在为微服务架构提供一种简单而有效的统一的API路由管理方式。

Spring Cloud Gateway作为Spring Cloud生态系中的网关，目标是替代ZUUL，其不仅提供统一的路由方式，并且基于Filter链的方式提供了网关基本的功能，例如：安全，监控/埋点，和限流等

<br>



## 2. 微服务架构解决方案

### Dubbo+Zookeeper

第一套解决方案：Apache Dubbo Zookeeper

技术架构：

- Zookeeper（服务注册中心）
- Dubbo-monitor（服务监控）

备注：Dubbo相当不完善，需要借助很多第三方组件



<br>



### Spring Cloud Netflix

第二套解决方案：Spring Cloud Netflix 【已停止开发，进入维护阶段】

技术架构：

- Eureka (服务注册与发现)

- Feign（整合了ribbon和Hystrix，负载均衡和熔断限流等）

- Ribbon（负载均衡）

- Hystrix （熔断限流，合并请求等）

  - Hystrix Dashboard 

    提供了服务监控的功能，提供了数据监控和友好的图形化界面

  - Hystrix Turbine 

    Hystrix Turbine将每个服务的Hystrix Dashboard数据进行了整合。也是监控系统的功能

- Zuul （智能路由和过滤）

五大神兽（Eureka、Ribbon、Hystrix 、Zuul 、Config ） 备注：2018年年底，Netflix宣布停止开发，进入维护模式。

<br>

以上两种方案对比：

最大区别：SpringCloud抛弃了Dubbo的RPC通信，采用的是基于HTTP的REST方式。 严格来说，这两种方式各有优劣。

虽然从一定程度上来说，后者牺牲了服务调用的性能，但避免了原生RPC带来的问题。而且REST相比RPC更为灵活，服务提供方和调用方的依赖只依靠一纸契约，不存在代码级别的强依赖，这在强调快速演化的微服务环境下，显得更加合适。

产品定位不同：Dubbo的定位是一款RPC框架，Spring Cloud的目标是微服务架构下的一站式解决方案



<br>



### Spring Cloud Alibaba

第三套解决方案：Spring Cloud Alibaba

技术架构：

- Nacos：一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。兼顾注册中心与配置中心。
- Sentinel：把流量作为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。
- RocketMQ：开源的分布式消息系统，基于高可用分布式集群技术，提供低延时的、高可靠的消息发布与订阅服务。
- Dubbo：国内应用非常广泛的一款高性能 Java RPC 框架。
- Seata：阿里巴巴开源产品，一个易于使用的高性能微服务分布式事务解决方案。
- Arthas：开源的Java动态追踪工具，基于字节码增强技术，功能非常强大。

<br>



### 目前常用的解决方案

对微服务的通俗理解：高内聚、低耦合

对SpringCloud的通俗理解：微服务工具集

<br>

三种解决方案的总结：

- Dubbo在一开始的定位是RPC框架，近几年随着微服务的兴起，才开始向着微服务解决方案更新迭代。

  但目前为止，Dubbo还相当不完善，需要借助很多第三方组件。

- Spring Cloud Netflix是一站式微服务解决方案，但已停止开发，进入维护阶段。

- Spring Cloud Alibaba是在Spring cloud netflix基础上封装了阿里巴巴的微服务解决方案，是目前最完善的微服务解决方案

<br>



综上，目前最佳方案是：

- 服务注册中心 Nacos
- 服务配置中心 Nacos
- 服务熔断组件 Sentinel
- 服务间通信组件 OpenFeign
- 服务网关组件 Gateway



<br>



# 三 SpringCloud Introduction











